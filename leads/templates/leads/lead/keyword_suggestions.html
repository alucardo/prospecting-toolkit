{% extends 'base.html' %}

{% block content %}

{% if batch and batch.status == 'pending' %}
<meta http-equiv="refresh" content="3">
{% endif %}

<div class="flex items-center gap-4 mb-6">
    <a href="{% url 'leads:lead_detail' lead.pk %}" class="btn btn-ghost btn-sm">‚Üê Wr√≥ƒá do leada</a>
    <h1 class="text-2xl font-bold">Sugestie fraz ‚Äî {{ lead.name }}</h1>
</div>

{% if messages %}
    {% for msg in messages %}
    <div class="alert alert-success mb-4">{{ msg }}</div>
    {% endfor %}
{% endif %}

{% if not batch %}
<!-- STAN: brak sugestii -->
<div class="card bg-base-200 max-w-lg mx-auto mt-12">
    <div class="card-body items-center text-center gap-4">
        <div class="text-5xl">üîç</div>
        <h2 class="card-title">Brak sugestii fraz</h2>
        <p class="text-gray-500 text-sm">
            AI przeanalizuje dane wizyt√≥wki{% if lead.website %} i stronƒô {{ lead.website }}{% endif %}
            oraz propozycje z Google i wybierze 10 najlepszych fraz dla tego lokalu.
        </p>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="generate">
            <button type="submit" class="btn btn-primary">‚ú® Generuj sugestie fraz</button>
        </form>
    </div>
</div>

{% elif batch.status == 'pending' %}
<!-- STAN: generowanie w toku -->
<div class="card bg-base-200 max-w-lg mx-auto mt-12">
    <div class="card-body items-center text-center gap-4">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <h2 class="card-title">Generowanie sugestii...</h2>
        <p class="text-gray-500 text-sm">
            Pobieram dane z DataForSEO{% if lead.website %}, scrapujƒô stronƒô WWW{% endif %} i pytam AI.
            Strona od≈õwie≈ºy siƒô automatycznie.
        </p>
    </div>
</div>

{% elif batch.status == 'error' %}
<!-- STAN: b≈ÇƒÖd -->
<div class="alert alert-error mb-4">
    <span>‚ùå B≈ÇƒÖd: {{ batch.error_message }}</span>
</div>
<form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="generate">
    <button type="submit" class="btn btn-primary">üîÑ Spr√≥buj ponownie</button>
</form>

{% elif batch.status == 'ready' %}
<!-- STAN: sugestie gotowe -->
<div class="flex justify-between items-center mb-4">
    <p class="text-sm text-gray-500">
        Wygenerowano {{ batch.created_at|date:"d.m.Y o H:i" }}
        {% if lead.website %} ¬∑ uwzglƒôdniono stronƒô WWW{% endif %}
    </p>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="generate">
        <button type="submit" class="btn btn-outline btn-sm">üîÑ Generuj ponownie</button>
    </form>
</div>

<form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="add_selected">

    <div class="card bg-base-200">
        <div class="card-body p-0">
            <table class="table table-sm">
                <thead>
                    <tr class="text-gray-400 text-xs">
                        <th class="w-8"></th>
                        <th>Fraza kluczowa</th>
                        <th class="text-right w-32">Wyszukiwa≈Ñ/mies.</th>
                        <th>Uzasadnienie AI</th>
                        <th class="w-24 text-center">Ju≈º dodana</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in batch.suggestions.all %}
                    {% if s.phrase in added_phrases %}
                    <tr class="opacity-50">
                    {% else %}
                    <tr>
                    {% endif %}
                        <td>
                            {% if s.phrase in added_phrases %}
                            <input type="checkbox" class="checkbox checkbox-sm" disabled>
                            {% else %}
                            <input type="checkbox" name="phrases" value="{{ s.pk }}" class="checkbox checkbox-sm checkbox-primary" checked>
                            {% endif %}
                        </td>
                        <td class="font-medium">{{ s.phrase }}</td>
                        <td class="text-right">
                            {% if s.volume %}
                            <span class="{% if s.volume >= 1000 %}text-success font-semibold{% elif s.volume >= 200 %}text-warning{% else %}text-gray-500{% endif %}">
                                {{ s.volume }}
                            </span>
                            {% else %}
                            <span class="text-gray-400">‚Äî</span>
                            {% endif %}
                        </td>
                        <td class="text-xs text-gray-500">{{ s.ai_reason }}</td>
                        <td class="text-center">
                            {% if s.phrase in added_phrases %}
                            <span class="badge badge-success badge-sm">‚úì dodana</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="flex justify-between items-center mt-4">
        <label class="flex items-center gap-2 text-sm cursor-pointer">
            <input type="checkbox" class="checkbox checkbox-sm" id="selectAll">
            Zaznacz wszystkie
        </label>
        <button type="submit" class="btn btn-primary">‚úÖ Dodaj zaznaczone do leada</button>
    </div>
</form>

{% endif %}

<style>
.badge-success { color: white !important; }
</style>

<script>
document.getElementById('selectAll')?.addEventListener('change', function () {
    document.querySelectorAll('input[name="phrases"]:not(:disabled)').forEach(function (cb) {
        cb.checked = document.getElementById('selectAll').checked;
    });
});
</script>

{% endblock %}
