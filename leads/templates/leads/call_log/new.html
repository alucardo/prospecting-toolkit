{% extends 'base.html' %}

{% block content %}

    <div class="max-w-lg">
        <div class="flex items-center gap-4 mb-6">
            <a href="{% url 'leads:lead_detail' lead.pk %}" class="btn btn-ghost btn-sm">‚Üê Wr√≥ƒá</a>
            <h1 class="text-2xl font-bold">Dodaj kontakt</h1>
            <span class="text-gray-500">{{ lead.name }}</span>
        </div>

        <div class="card bg-base-200">
            <div class="card-body flex flex-col gap-3">
                <form method="post" id="callLogForm">
                    {% csrf_token %}
                    {% for field in form %}
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">{{ field.label }}</span>
                        </label>
                        {% if field.html_name == 'note' %}
                        {{ field }}
                        <!-- Przyciski nagrywania pod polem notatki -->
                        <div class="flex items-center gap-2 mt-2">
                            <button type="button" id="recordBtn" class="btn btn-outline btn-sm gap-2">
                                üéôÔ∏è Nagraj notatkƒô g≈ÇosowƒÖ
                            </button>
                            <span id="recordStatus" class="text-xs text-gray-400"></span>
                        </div>
                        {% else %}
                        {{ field }}
                        {% endif %}
                        {% if field.errors %}
                        <div class="text-error text-sm mt-1">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    <button type="submit" class="btn btn-primary w-full mt-2">Zapisz</button>
                </form>
            </div>
        </div>
    </div>

<script>
(function () {
    const btn = document.getElementById('recordBtn');
    const status = document.getElementById('recordStatus');
    const noteField = document.querySelector('[name="note"]');
    const transcribeUrl = '{% url "leads:whisper_transcribe" %}';
    const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;

    let mediaRecorder = null;
    let chunks = [];
    let isRecording = false;

    btn.addEventListener('click', async function () {
        if (!isRecording) {
            // START nagrywania
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                chunks = [];
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = e => chunks.push(e.data);

                mediaRecorder.onstop = async function () {
                    // Zatrzymaj mikrofon
                    stream.getTracks().forEach(t => t.stop());

                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    const formData = new FormData();
                    formData.append('audio', blob, 'recording.webm');
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    btn.disabled = true;
                    status.textContent = '‚è≥ Transkrybujƒô...';

                    try {
                        const resp = await fetch(transcribeUrl, { method: 'POST', body: formData });
                        const data = await resp.json();
                        if (data.text) {
                            // Do≈ÇƒÖcz do istniejƒÖcej notatki
                            const existing = noteField.value.trim();
                            noteField.value = existing ? existing + '\n' + data.text : data.text;
                            status.textContent = '‚úì Gotowe';
                        } else {
                            status.textContent = '‚ùå ' + (data.error || 'B≈ÇƒÖd transkrypcji');
                        }
                    } catch (e) {
                        status.textContent = '‚ùå B≈ÇƒÖd po≈ÇƒÖczenia';
                    } finally {
                        btn.disabled = false;
                        btn.textContent = 'üéôÔ∏è Nagraj notatkƒô g≈ÇosowƒÖ';
                        isRecording = false;
                    }
                };

                mediaRecorder.start();
                isRecording = true;
                btn.innerHTML = '‚èπÔ∏è Zatrzymaj nagrywanie';
                btn.classList.add('btn-error');
                btn.classList.remove('btn-outline');

                // Licznik czasu
                let seconds = 0;
                const timer = setInterval(() => {
                    if (!isRecording) { clearInterval(timer); return; }
                    seconds++;
                    status.textContent = `üî¥ ${seconds}s`;
                }, 1000);

            } catch (e) {
                status.textContent = '‚ùå Brak dostƒôpu do mikrofonu';
            }
        } else {
            // STOP nagrywania
            mediaRecorder.stop();
            isRecording = false;
        }
    });
})();
</script>

{% endblock %}
